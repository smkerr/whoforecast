```{r lockfile-rt, include = FALSE, message = FALSE}
renv::use(
  "epitrix@0.4.0",
  "sodium@1.3.1", # requires the libsodium system dependency
  "ciTools@0.6.1"
)
```

### Explanations

We fit negative binomials GLMs to epidemic curves to estimate daily growth rates
'_r_'. These estimates can be biased by reporting delays. Here, we exclude the
last `r params$incomplete_days` days as incomplete, and retain a total of 
`r params$r_estim_window` days to estimate the growth rate.

Growth rates can be interpreted as the percent change in daily
incidence. Positive numbers indicate growth, while negative numbers indicate a
decline of the epidemic. For instance:

* $r = 0.02$ means that the number of new cases increases on average by 2% each day
* $r = -0.13$ means that the number of new cases decreases on average by 13% each day

For more information on growth rates, see this [blog post by Pr Julia Gog](https://plus.maths.org/content/epidemic-growth-rate).

### Results

This section contains:

* graphs showing the models fitted to epidemic curves by `r group_var`, with their associated 95% confidence
intervals (CI)

* graphs showing the estimates of the growth rates ($r$) with their 95% CI for each `r group_var`

* a table summarizing estimates of $r$ and the associated period (doubling or
  halving time) for each `r group_var`; all results show point estimates and their 95% CI

```{r fig.height = 5 / 3 * n_groups}
last_counts <- dat_i_day %>%
  keep_last(params$r_estim_window + params$incomplete_days)

last_trends <- last_counts  %>%
  nest(.key = "data") %>%
  mutate(model = lapply(data, function(d) {
    MASS::glm.nb(count ~ date_index, d, control = glm.control(maxit = 1e3))
  }))

intervals <- last_trends %>%
  mutate(result = Map(
    function(data, model) {
      data %>%
        ciTools::add_ci(model, names = c("lower_ci", "upper_ci")) %>%
        ciTools::add_pi(model, names = c("lower_pi", "upper_pi")) %>%
        as_tibble()
    },
    data,
    model
  )) %>%
  dplyr::select(any_of(c(group_var, "result"))) %>%
  unnest(result)

plot(last_counts, angle = 45) +
  geom_line(
    aes(date_index, y = pred),
    data = intervals,
    inherit.aes = FALSE
  ) +
  geom_ribbon(
    aes(date_index, ymin = lower_pi, ymax = upper_pi),
    alpha = 0.2,
    data = intervals,
    inherit.aes = FALSE,
    fill = "#BBB67E"
  )
```

```{r}
growth_rates <- last_trends %>%
  mutate(
    growth = bind_rows(lapply(
      model,
      function(m) {
        ci <- confint(m, 2L, level = 0.95)
        tibble(r_lower = ci[1L], r = coef(m)[2L], r_upper = ci[2L])
      }
    ))
  ) %>%
  unpack(growth)

message(colnames(growth_rates))
growth_rates <- growth_rates %>%
  dplyr::select(all_of(c(group_var, "r", "r_lower", "r_upper")))

growth_rates %>%
  ggplot(aes(y = .data[[group_var]]), fill = custom_grey) +
  geom_point(aes(x = r), color = dark_green) +
  geom_errorbar(aes(xmin = r_lower, xmax = r_upper), color = dark_green) +
  scale_x_continuous(labels = scales::percent) +
  geom_vline(xintercept = 0, color = dark_pink) +
  labs(
    title = "Estimates of daily growth rates",
    subtitle = sprintf(
      "based on data from %s - %s",
      format(min(get_dates(last_counts)), "%d %B %Y"),
      format(max(get_dates(last_counts)), "%d %B %Y")
    ),
    y = "",
    x = "Daily rate of change"
  )

# This code generates a table where estimated growth rates and doubling/halving
# times are displayed per group_var over the last params$r_estim_window +
# params$incomplete_days days included in params$data_file
growth_rates %>%
  mutate(
    r = paste(round(r * 100, 1), "%"),
    r_ci = sprintf(
      "[%1.1f %% ; %1.1f %% ]",
      r_lower * 100,
      r_upper * 100
    )
  ) %>%
  dplyr::select(
    group_var,
    "Daily growth rate" = r,
    "Growth rate (95% CI)" = r_ci
  ) %>%
  set_names(toupper) %>%
  kbl() %>%
  kable_paper("striped", font_size = 18, full_width = FALSE)
```

#### Estimating $R$ from the growth rates

Wallinga and Lipsitch have introduced methods for converting daily growth rates
($r$) into reproduction numbers ($R$) [@Wallinga2007-hw], when information on
the serial interval distribution is available. $R$ represents the average number
of secondary cases generated by an infected patient. Like the daily growth rate,
$R$ can be used to gauge the dynamics of an epidemic:

* $R > 1$: the epidemic will grow exponentially
* $R < 1$: the epidemic will decline exponentially

Note that $R$ only speaks to the number of new cases created, not how fast these
are generated, so on its own it is not sufficient to indicate how fast the
epidemic is growing. For a comparison of $r$ and $R$, we recommend reading this
[blog post by Pr Julia Gog](https://plus.maths.org/content/epidemic-growth-rate).

Here, we use the procedure implemented in `epitrix` to derive samples of $R$
values compatible with the values of $r$ estimated in the previous section, and
with the provided serial interval.

This section contains:

* a graph showing the distribution of $R$ values estimated from the daily growth
  rates by `r group_var`; each violin shows the density of values based on a sample of 500 from
  the Student distribution associated with the estimate of $r$; the line range
  represents the 95% confidence interval (horizontal segment) and the median
  (dot)
  
* a table summarizing the estimated distributions of $R$ values for each `r group_var`

```{r }
# This code generates a violin plot that displays R values per group_var for the
# last params$r_estim_window + params$incomplete_days days included in
# params$data_file
res_R_wl <- last_trends %>%
  mutate(R = map(model, epitrix::lm2R0_sample, w = si$prob_dist$d(si_x))) %>%
  dplyr::select({{ group_var }}, R) %>%
  unnest(R)

res_R_wl_smry <- res_R_wl %>%
  group_by(.data[[group_var]]) %>%
  summarise(
    mean   = mean(R),
    median = median(R),
    lower  = quantile(R, 0.025),
    upper  = quantile(R, 0.975)
  )

res_R_wl %>%
  ggplot(aes(y = .data[[group_var]]), fill = custom_grey) +
  geom_violin(aes(x = R), fill = pale_green, color = green_grey) +
  geom_pointrange(
    data = res_R_wl_smry,
    aes(x = median, xmin = lower, xmax = upper),
    color = dark_green
  ) +
  geom_vline(xintercept = 1, color = dark_pink) +
  labs(
    title = "Reproduction numbers estimated from growth rates",
    subtitle = sprintf(
      "based on data from %s - %s",
      format(min(get_dates(last_counts)), "%d %B %Y"),
      format(max(get_dates(last_counts)), "%d %B %Y")
    ),
    y = "",
    x = "Reproduction number"
  )

# This code generates a table with estimates of the reproduction number by
# group_var for the last params$r_estim_window + params$incomplete_days days
# included in params$data_file
res_R_wl_smry %>%
  mutate(
    mean = round(mean, 2),
    median = round(median, 2),
    `95% ci` = sprintf(
      "[%1.2f ; %1.2f]",
      lower,
      upper
    )
  ) %>%
  dplyr::select(-c(lower, upper)) %>%
  rename(
    "mean $R$" = mean,
    "median $R$" = median
  ) %>%
  set_names(toupper) %>%
  kbl() %>%
  kable_paper("striped", font_size = 18, full_width = FALSE)
```
